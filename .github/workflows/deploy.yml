name: Deploy container image to Cloud Run

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag for the Docker image'
        required: false

jobs:
  set_env:
    runs-on: ubuntu-latest
    outputs:
      env: ${{ steps.set_env.outputs.ENV }}
    steps:
      - name: set-env
        id: set_env
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            case "${{ github.event.inputs.tag }}" in
              *[0-9]-stg) echo "::set-output name=ENV::stg" ;;
              *[0-9]-prd) echo "::set-output name=ENV::prod" ;;
              *[0-9]-dev) echo "::set-output name=ENV::dev" ;;
              *) echo "::set-output name=ENV::unknown" ;;
            esac
          else
            echo "No tag provided, unable to determine environment."
            exit 1
          fi

  deploy:
    needs: set_env
    env:
      SERVICE_NAME: typescript-boilerplate-${{ needs.set_env.outputs.env}}
      IMAGE_NAME: typescript-boilerplate-${{ needs.set_env.outputs.env}}
      REGION: ${{ secrets.REGION }}
      REPO_NAME: ${{ secrets.REPO_NAME }}-${{ needs.set_env.outputs.env}}
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
      SERVICE_ACCOUNT_EMAIL: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}
      SERVICE_ACCOUNT_KEY: ${{ secrets.SERVICE_ACCOUNT_KEY }}
      CLOUDSDK_PYTHON: '/usr/bin/python3'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Python
        run: |
          if [ ! -f /usr/bin/python3 ]; then
            sudo apt-get update
            sudo apt-get install -y python3
            sudo ln -s /usr/bin/python3 /usr/bin/python3
          fi

      - name: Verify Python installation
        run: |
          /usr/local/bin/python3 --version

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v0'
        with:
          credentials_json: ${{ env.SERVICE_ACCOUNT_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0.2.0
        with:
          version: '340.0.0'
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ env.SERVICE_ACCOUNT_KEY }}
          export_default_credentials: true

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v0
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{env.REGION}}-docker.pkg.dev/${{env.PROJECT_ID}}/${{env.REPO_NAME}}/${{env.IMAGE_NAME}}:${{inputs.tag}}
